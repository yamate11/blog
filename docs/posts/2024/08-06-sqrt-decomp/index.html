<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>平方分割ライブラリ | yamate11のブログ</title>
<meta name="keywords" content="">
<meta name="description" content="平方分割ライブラリを書きました">
<meta name="author" content="yamate11">
<link rel="canonical" href="https://yamate11.github.io/blog/posts/2024/08-06-sqrt-decomp/">
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.cfdb0c3379ef447c9f679190e89f76ab7e6d5dc5b725c57799a66e44b92c2d56.css" integrity="sha256-z9sMM3nvRHyfZ5GQ6J92q35tXcW3JcV3maZuRLksLVY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://yamate11.github.io/blog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yamate11.github.io/blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yamate11.github.io/blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yamate11.github.io/blog/apple-touch-icon.png">
<link rel="mask-icon" href="https://yamate11.github.io/blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
    MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        tags: "ams",
        autoload: {
          color: [],
          colorV2: ['color']
        },
        packages: {'[+]': ['noerrors']}
      },
      chtml: {
        matchFontHeight: false,
          

      },
      loader: {
        load: ['[tex]/noerrors']
      }
    };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>



<meta property="og:title" content="平方分割ライブラリ" />
<meta property="og:description" content="平方分割ライブラリを書きました" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yamate11.github.io/blog/posts/2024/08-06-sqrt-decomp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-06T17:29:16+09:00" />
<meta property="article:modified_time" content="2024-08-06T17:29:16+09:00" /><meta property="og:site_name" content="yamate11のブログ" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="平方分割ライブラリ"/>
<meta name="twitter:description" content="平方分割ライブラリを書きました"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yamate11.github.io/blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "平方分割ライブラリ",
      "item": "https://yamate11.github.io/blog/posts/2024/08-06-sqrt-decomp/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "平方分割ライブラリ",
  "name": "平方分割ライブラリ",
  "description": "平方分割ライブラリを書きました",
  "keywords": [
    
  ],
  "articleBody": "概要 SRD という構造体を定義した．名前は，Square Root Decomposition から．\n各ブロックに対応したデータを保存するためのデータ型 S を，テンプレート引数としてとる． もとのベクトル長を，コンストラクタの引数として取る．srd.tot_size で参照可能． ブロックサイズ srd.bsize は，デフォルトでは $\\sqrt{\\texttt{srd.tot_size}}$ だが， コンストラクタの引数で指定することもできる． ブロックの数は，srd.numb でアクセスできる． ブロック b (第 b 番目のブロック) の要素数は，srd.block_size(b) である． これは，たいてい srd.bsize に等しいが，最後のブロックだけは異なるかもしれない． ブロック b の第 i 要素は，もとのベクトルの添字で idx に対応している場合，次が成り立つ． idx == srd.pos2idx(b, i) pair{b, i} == srd.idx2pos(idx) 型 S のデータのベクトル (ブロック数と同じ長さを持つ) が，自動的に作成される． (したがって，S は引数無しで構築できなければならない．) ブロック b に対応するデータは，srd.data(b) でアクセスできる． アルゴリズムの記述 多くの (?) 問題では，次の順で処理が進むと思われる．\n左端のブロックを処理する．この際，対象となる要素を左から順に1つずつ処理する． (存在すれば) 中央のブロックを，左から順に処理する． (存在すれば) 右端のブロックを処理する．左端のブロックの処理と同じ内容を行う． このパターンの場合には，次のように処理が書ける:\nまず，両端のブロックを処理するための関数を書く． 関数は，ブロック番号，それに対応するデータへの参照，ブロック内添字，もとの添字 を引数に取り，この要素の処理内容を記述する． auto fe = [\u0026](int b, S\u0026 s, int i, int idx) -\u003e void { .... }; なお，s == srd.data(b), idx == srd.pos2idx(b, i) という関係がある． 次に，中央のブロックを処理するための関数を書く． 関数は，ブロック番号と，それに対応するデータへの参照を引数に取り，このブロックの処理内容を記述する． auto fb = [\u0026](int b, S\u0026 s) -\u003e void { .... }; なお，s == srd.data(b) という関係がある． 最後に，これらの関数を実行する． srd.exec(lo, hi, fe, fb); 上に記述した順序で処理が実行される．(他にも引数が渡せる．下の説明を参照．) 使用例 ベクトル $A$ に対し，区間への加算と，区間和を求めるクエリを処理する，という例題で示す．\n各ブロックで，「ブロックの要素の和」と「シフト量」を保持する．\nstruct S { ll shift; // シフト量 ll sum; // このブロックの要素の和 S() : shift(0), sum(0) {} }; }; 「シフト量」は，ブロック全体に数を加えるときに，全部の要素に加えるのではなく， 「このブロックの各要素には実はこれだけの量が加えられている」というのを覚えるために使う．\nvector\u003cll\u003e A(a_size); REP(i, 0, a_size) cin \u003e\u003e A[i]; SRD\u003cS\u003e srd(a_size); // 平方分割用のオブジェクトを作成する．要素数を引数にする． // テンプレートパラメタに，ブロック情報を保持するデータの型を指定する // 各ブロックに対して，`S.sum` を設定する． REP(i, 0, a_size) { auto [b, _j] = srd.idx2pos(i); srd.data(b).sum += A[i]; } REP(_q, 0, Q) { ll tp, lo, hi; cin \u003e\u003e tp \u003e\u003e lo \u003e\u003e hi; if (tp == MODIFY) { ll val; cin \u003e\u003e val; // まず，両端のブロックで行うべき処理を，関数として書く． auto fe = [\u0026](ll b, S\u0026 s, ll i, ll idx) { A[idx] += a; s.sum += a; }; // 次に，両端以外のブロックで行うべき処理を書く． auto fb = [\u0026](ll b, S\u0026 s) { s.sum += a * srd.block_size(b); s.shift += a; }; // 最後に，書いた関数を実行する． srd.exec(lo, hi, fe, fb); }else if (tp == ASK) { ll ret = 0; auto fe = [\u0026](ll b, S\u0026 s, ll i, ll idx) { ret += s.shift + A[idx]; }; auto fb = [\u0026](ll b, S\u0026 s) { ret += s.sum; }; srd.exec(lo, hi, fe, fb); cout \u003c\u003c ret \u003c\u003c \"\\n\"; } } その他 範囲 range_pos もとの添字の範囲 [lo, hi) に対応するブロック番号やブロック内添字の範囲は，range_pos で取得できる．\nauto [b0, l0, h0, b1, l1, h1] = range_pos(lo, hi); ブロックが1個になる場合，b0 == b1 で，これがブロック番号である． ブロック b0 の [l0, h0) が，要素の範囲となる． l1 と h1 には，0 が設定される． そうでない場合，b0 \u003c b1 となる．b0 が左端のブロック，b1 が右端のブロック， b0 + 1 から b1 - 1 までが中央のブロックとなる． ブロック b0 の要素範囲は，[l0, h0) で， ブロック b1 の要素範囲は，[l1, h1) である． (したがって，いずれの場合も l1 には 0 が返される．冗長であるが，わかりやすさを優先した．) exec 上述のパターンに近いが，必ずしもループが1回と限らない場合には， exec にさらに関数を追加できる．\ntemplate\u003ctypename F0e = nullptr_t, typename F0c = nullptr_t, typename F1e = nullptr_t, typename F1c = nullptr_t\u003e void exec(int lo, int hi, auto edge_body, auto core_body, F0e edge_pre = nullptr, F0c core_pre = nullptr, F1e edge_post = nullptr, F1c core_post = nullptr); 最初の4つの引数は，上で説明した．その後に4つの省略可能な引数がある． edge_pre と edge_post (順序に注意) には，次の形式の関数を渡す 実行時には，引数には，端のブロック番号と対応するデータへの参照が渡される． auto f = [\u0026](int b, S\u0026 s) -\u003e void { ... }; core_pre と core_post (順序に注意) には，次の形式の関数を渡す auto f = [\u0026]() -\u003e void { ... }; 実行される順序は次の通り 左端ブロックに対して edge_pre 左端の各要素に対して edge_core 左端ブロックに対して edge_post (中央ブロックが存在する場合) core_pre 中央の各ブロックに対して core_body (中央ブロックが存在する場合) core_post 右端ブロックに対して edge_pre 右端の各要素に対して edge_core 右端ブロックに対して edge_post edge_body，edge_core も含め，実行が不要な場合には nullptr を渡せば良い． ",
  "wordCount" : "457",
  "inLanguage": "en",
  "datePublished": "2024-08-06T17:29:16+09:00",
  "dateModified": "2024-08-06T17:29:16+09:00",
  "author":{
    "@type": "Person",
    "name": "yamate11"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yamate11.github.io/blog/posts/2024/08-06-sqrt-decomp/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "yamate11のブログ",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yamate11.github.io/blog/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://yamate11.github.io/blog/" accesskey="h" title="yamate11のブログ (Alt + H)">yamate11のブログ</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yamate11.github.io/blog/archives/" title="記事一覧">
                    <span>記事一覧</span>
                </a>
            </li>
            <li>
                <a href="https://yamate11.github.io/blog/search/" title="検索 (Alt &#43; /)" accesskey=/>
                    <span>検索</span>
                </a>
            </li>
            <li>
                <a href="https://yamate11.github.io/blog/pages/about/" title="筆者">
                    <span>筆者</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      平方分割ライブラリ
    </h1>
    <div class="post-meta">2024-08-06   yamate11
</div>
  </header> 
  <div class="post-content"><h2 id="概要">概要<a hidden class="anchor" aria-hidden="true" href="#概要">#</a></h2>
<p><code>SRD</code> という構造体を定義した．名前は，Square Root Decomposition から．</p>
<ul>
<li>各ブロックに対応したデータを保存するためのデータ型 <code>S</code> を，テンプレート引数としてとる．</li>
<li>もとのベクトル長を，コンストラクタの引数として取る．<code>srd.tot_size</code> で参照可能．</li>
<li>ブロックサイズ <code>srd.bsize</code> は，デフォルトでは $\sqrt{\texttt{srd.tot_size}}$ だが，
コンストラクタの引数で指定することもできる．</li>
<li>ブロックの数は，<code>srd.numb</code> でアクセスできる．</li>
<li>ブロック b (第 b 番目のブロック) の要素数は，<code>srd.block_size(b)</code> である．
これは，たいてい <code>srd.bsize</code> に等しいが，最後のブロックだけは異なるかもしれない．</li>
<li>ブロック b の第 i 要素は，もとのベクトルの添字で idx に対応している場合，次が成り立つ．
<ul>
<li><code>idx == srd.pos2idx(b, i)</code></li>
<li><code>pair&lt;int, int&gt;{b, i} == srd.idx2pos(idx)</code></li>
</ul>
</li>
<li>型 <code>S</code> のデータのベクトル (ブロック数と同じ長さを持つ) が，自動的に作成される．
(したがって，<code>S</code> は引数無しで構築できなければならない．)
ブロック b に対応するデータは，<code>srd.data(b)</code> でアクセスできる．</li>
</ul>
<h3 id="アルゴリズムの記述">アルゴリズムの記述<a hidden class="anchor" aria-hidden="true" href="#アルゴリズムの記述">#</a></h3>
<p>多くの (?) 問題では，次の順で処理が進むと思われる．</p>
<ul>
<li>左端のブロックを処理する．この際，対象となる要素を左から順に1つずつ処理する．</li>
<li>(存在すれば) 中央のブロックを，左から順に処理する．</li>
<li>(存在すれば) 右端のブロックを処理する．左端のブロックの処理と同じ内容を行う．</li>
</ul>
<p>このパターンの場合には，次のように処理が書ける:</p>
<ul>
<li>まず，両端のブロックを処理するための関数を書く．
関数は，ブロック番号，それに対応するデータへの参照，ブロック内添字，もとの添字
を引数に取り，この要素の処理内容を記述する．
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00a8c8">auto</span> <span style="color:#111">fe</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#00a8c8">int</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">i</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">idx</span><span style="color:#111">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">void</span> <span style="color:#111">{</span> <span style="color:#111">....</span> <span style="color:#111">};</span>
</span></span></code></pre></div>なお，<code>s == srd.data(b)</code>, <code>idx == srd.pos2idx(b, i)</code> という関係がある．</li>
<li>次に，中央のブロックを処理するための関数を書く．
関数は，ブロック番号と，それに対応するデータへの参照を引数に取り，このブロックの処理内容を記述する．
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00a8c8">auto</span> <span style="color:#111">fb</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#00a8c8">int</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">void</span> <span style="color:#111">{</span> <span style="color:#111">....</span> <span style="color:#111">};</span>
</span></span></code></pre></div>なお，<code>s == srd.data(b)</code> という関係がある．</li>
<li>最後に，これらの関数を実行する．
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">exec</span><span style="color:#111">(</span><span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#111">hi</span><span style="color:#111">,</span> <span style="color:#111">fe</span><span style="color:#111">,</span> <span style="color:#111">fb</span><span style="color:#111">);</span>
</span></span></code></pre></div>上に記述した順序で処理が実行される．(他にも引数が渡せる．下の説明を参照．)</li>
</ul>
<h2 id="使用例">使用例<a hidden class="anchor" aria-hidden="true" href="#使用例">#</a></h2>
<p>ベクトル $A$ に対し，区間への加算と，区間和を求めるクエリを処理する，という例題で示す．</p>
<p>各ブロックで，「ブロックの要素の和」と「シフト量」を保持する．</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#00a8c8">struct</span> <span style="color:#75af00">S</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ll</span> <span style="color:#111">shift</span><span style="color:#111">;</span>    <span style="color:#75715e">// シフト量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#111">ll</span> <span style="color:#111">sum</span><span style="color:#111">;</span>      <span style="color:#75715e">// このブロックの要素の和
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#111">S</span><span style="color:#111">()</span> <span style="color:#f92672">:</span> <span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">),</span> <span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">};</span>
</span></span><span style="display:flex;"><span><span style="color:#111">};</span>
</span></span></code></pre></div><p>「シフト量」は，ブロック全体に数を加えるときに，全部の要素に加えるのではなく，
「このブロックの各要素には実はこれだけの量が加えられている」というのを覚えるために使う．</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#111">ll</span><span style="color:#f92672">&gt;</span> <span style="color:#111">A</span><span style="color:#111">(</span><span style="color:#111">a_size</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">REP</span><span style="color:#111">(</span><span style="color:#111">i</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">a_size</span><span style="color:#111">)</span> <span style="color:#111">cin</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">A</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">SRD</span><span style="color:#f92672">&lt;</span><span style="color:#111">S</span><span style="color:#f92672">&gt;</span> <span style="color:#111">srd</span><span style="color:#111">(</span><span style="color:#111">a_size</span><span style="color:#111">);</span>   <span style="color:#75715e">// 平方分割用のオブジェクトを作成する．要素数を引数にする．
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                          <span style="color:#75715e">// テンプレートパラメタに，ブロック情報を保持するデータの型を指定する
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 各ブロックに対して，`S.sum` を設定する．
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#111">REP</span><span style="color:#111">(</span><span style="color:#111">i</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">a_size</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">auto</span> <span style="color:#111">[</span><span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">_j</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">idx2pos</span><span style="color:#111">(</span><span style="color:#111">i</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">).</span><span style="color:#111">sum</span> <span style="color:#f92672">+=</span> <span style="color:#111">A</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">REP</span><span style="color:#111">(</span><span style="color:#111">_q</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">Q</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">ll</span> <span style="color:#111">tp</span><span style="color:#111">,</span> <span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#111">hi</span><span style="color:#111">;</span> <span style="color:#111">cin</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">tp</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">lo</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">hi</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">tp</span> <span style="color:#f92672">==</span> <span style="color:#111">MODIFY</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ll</span> <span style="color:#111">val</span><span style="color:#111">;</span> <span style="color:#111">cin</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">val</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// まず，両端のブロックで行うべき処理を，関数として書く．
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#00a8c8">auto</span> <span style="color:#111">fe</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#111">ll</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">,</span> <span style="color:#111">ll</span> <span style="color:#111">i</span><span style="color:#111">,</span> <span style="color:#111">ll</span> <span style="color:#111">idx</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">A</span><span style="color:#111">[</span><span style="color:#111">idx</span><span style="color:#111">]</span> <span style="color:#f92672">+=</span> <span style="color:#111">a</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">s</span><span style="color:#111">.</span><span style="color:#111">sum</span> <span style="color:#f92672">+=</span> <span style="color:#111">a</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 次に，両端以外のブロックで行うべき処理を書く．
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#00a8c8">auto</span> <span style="color:#111">fb</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#111">ll</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">s</span><span style="color:#111">.</span><span style="color:#111">sum</span> <span style="color:#f92672">+=</span> <span style="color:#111">a</span> <span style="color:#f92672">*</span> <span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">block_size</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">s</span><span style="color:#111">.</span><span style="color:#111">shift</span> <span style="color:#f92672">+=</span> <span style="color:#111">a</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 最後に，書いた関数を実行する．
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">exec</span><span style="color:#111">(</span><span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#111">hi</span><span style="color:#111">,</span> <span style="color:#111">fe</span><span style="color:#111">,</span> <span style="color:#111">fb</span><span style="color:#111">);</span>      
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span><span style="color:#00a8c8">else</span> <span style="color:#75af00">if</span> <span style="color:#111">(</span><span style="color:#111">tp</span> <span style="color:#f92672">==</span> <span style="color:#111">ASK</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ll</span> <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">auto</span> <span style="color:#111">fe</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#111">ll</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">,</span> <span style="color:#111">ll</span> <span style="color:#111">i</span><span style="color:#111">,</span> <span style="color:#111">ll</span> <span style="color:#111">idx</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">ret</span> <span style="color:#f92672">+=</span> <span style="color:#111">s</span><span style="color:#111">.</span><span style="color:#111">shift</span> <span style="color:#f92672">+</span> <span style="color:#111">A</span><span style="color:#111">[</span><span style="color:#111">idx</span><span style="color:#111">];</span> <span style="color:#111">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">auto</span> <span style="color:#111">fb</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#111">ll</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">ret</span> <span style="color:#f92672">+=</span> <span style="color:#111">s</span><span style="color:#111">.</span><span style="color:#111">sum</span><span style="color:#111">;</span> <span style="color:#111">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">srd</span><span style="color:#111">.</span><span style="color:#111">exec</span><span style="color:#111">(</span><span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#111">hi</span><span style="color:#111">,</span> <span style="color:#111">fe</span><span style="color:#111">,</span> <span style="color:#111">fb</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">cout</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#111">ret</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#d88200">&#34;</span><span style="color:#8045ff">\n</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="その他">その他<a hidden class="anchor" aria-hidden="true" href="#その他">#</a></h3>
<h4 id="範囲-range_pos">範囲 range_pos<a hidden class="anchor" aria-hidden="true" href="#範囲-range_pos">#</a></h4>
<p>もとの添字の範囲 <code>[lo, hi)</code> に対応するブロック番号やブロック内添字の範囲は，<code>range_pos</code> で取得できる．</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00a8c8">auto</span> <span style="color:#111">[</span><span style="color:#111">b0</span><span style="color:#111">,</span> <span style="color:#111">l0</span><span style="color:#111">,</span> <span style="color:#111">h0</span><span style="color:#111">,</span> <span style="color:#111">b1</span><span style="color:#111">,</span> <span style="color:#111">l1</span><span style="color:#111">,</span> <span style="color:#111">h1</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">range_pos</span><span style="color:#111">(</span><span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#111">hi</span><span style="color:#111">);</span>
</span></span></code></pre></div><ul>
<li>ブロックが1個になる場合，<code>b0 == b1</code> で，これがブロック番号である．
ブロック <code>b0</code> の <code>[l0, h0)</code> が，要素の範囲となる．
<code>l1</code> と <code>h1</code> には，0 が設定される．</li>
<li>そうでない場合，<code>b0 &lt; b1</code> となる．<code>b0</code> が左端のブロック，<code>b1</code> が右端のブロック，
<code>b0 + 1</code> から <code>b1 - 1</code> までが中央のブロックとなる．
ブロック <code>b0</code> の要素範囲は，<code>[l0, h0)</code> で，
ブロック <code>b1</code> の要素範囲は，<code>[l1, h1)</code> である．</li>
<li>(したがって，いずれの場合も l1 には 0 が返される．冗長であるが，わかりやすさを優先した．)</li>
</ul>
<h4 id="exec">exec<a hidden class="anchor" aria-hidden="true" href="#exec">#</a></h4>
<p>上述のパターンに近いが，必ずしもループが1回と限らない場合には，
<code>exec</code> にさらに関数を追加できる．</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">F0e</span> <span style="color:#f92672">=</span> <span style="color:#111">nullptr_t</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">F0c</span> <span style="color:#f92672">=</span> <span style="color:#111">nullptr_t</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#00a8c8">typename</span> <span style="color:#111">F1e</span> <span style="color:#f92672">=</span> <span style="color:#111">nullptr_t</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">F1c</span> <span style="color:#f92672">=</span> <span style="color:#111">nullptr_t</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">void</span> <span style="color:#111">exec</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">lo</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">hi</span><span style="color:#111">,</span> <span style="color:#00a8c8">auto</span> <span style="color:#111">edge_body</span><span style="color:#111">,</span> <span style="color:#00a8c8">auto</span> <span style="color:#111">core_body</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">F0e</span> <span style="color:#111">edge_pre</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">nullptr</span><span style="color:#111">,</span> <span style="color:#111">F0c</span> <span style="color:#111">core_pre</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">nullptr</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">F1e</span> <span style="color:#111">edge_post</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">nullptr</span><span style="color:#111">,</span> <span style="color:#111">F1c</span> <span style="color:#111">core_post</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">nullptr</span><span style="color:#111">);</span>
</span></span></code></pre></div><ul>
<li>最初の4つの引数は，上で説明した．その後に4つの省略可能な引数がある．</li>
<li>edge_pre と edge_post (順序に注意) には，次の形式の関数を渡す
実行時には，引数には，端のブロック番号と対応するデータへの参照が渡される．
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00a8c8">auto</span> <span style="color:#111">f</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">](</span><span style="color:#00a8c8">int</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">S</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">void</span> <span style="color:#111">{</span> <span style="color:#111">...</span> <span style="color:#111">};</span>
</span></span></code></pre></div></li>
<li>core_pre と core_post (順序に注意) には，次の形式の関数を渡す
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00a8c8">auto</span> <span style="color:#111">f</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#f92672">&amp;</span><span style="color:#111">]()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">void</span> <span style="color:#111">{</span> <span style="color:#111">...</span> <span style="color:#111">};</span>
</span></span></code></pre></div></li>
<li>実行される順序は次の通り
<ul>
<li>左端ブロックに対して edge_pre</li>
<li>左端の各要素に対して edge_core</li>
<li>左端ブロックに対して edge_post</li>
<li>(中央ブロックが存在する場合) core_pre</li>
<li>中央の各ブロックに対して core_body</li>
<li>(中央ブロックが存在する場合) core_post</li>
<li>右端ブロックに対して edge_pre</li>
<li>右端の各要素に対して edge_core</li>
<li>右端ブロックに対して edge_post</li>
</ul>
</li>
<li>edge_body，edge_core も含め，実行が不要な場合には <code>nullptr</code> を渡せば良い．</li>
</ul>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://yamate11.github.io/blog/posts/2022/02-13-zobrist-hash/">
    <span class="title">« Prev</span>
    <br>
    <span>集合・多重集合のハッシュ</span>
  </a>
  <a class="next" href="https://yamate11.github.io/blog/posts/2024/06-23-merge-tech-tree-dp/">
    <span class="title">Next »</span>
    <br>
    <span>木DP &#43; マージテク</span>
  </a>
</nav>

  </footer><p>コメントをどうぞ</p>

<script src="https://y1.is-trm.net/isso/js/embed.min.js"
     data-isso="https://y1.is-trm.net/isso/">
</script>
<section id="isso-thread" data-isso-id="/blog/posts/2024/08-06-sqrt-decomp/" data-title="平方分割ライブラリ">
</section>

<p>Links to Recent Posts:
  / <a href="https://yamate11.github.io/blog/posts/">Posts</a>
  / <a href="https://yamate11.github.io/blog/posts/2024/06-04-easy-to-forget/">忘れやすい事項</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/06-08-stern-brocot/">Stern Brocot Tree (連分数)</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/05-18-ret-abc349-g/">ABC349 G Palindrome Construction</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/05-17-wavelet-matrix-lib/">Wavelet 行列ライブラリ</a>
  / <a href="https://yamate11.github.io/blog/posts/2024/11-04-comparator-in-set-etc/">比較関数</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/05-05-bellman-ford/">Bellman-Ford, 牛ゲーライブラリ</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/05-04-ret-abc404-g/">ABC404 G - Specified Range Sums</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/04-27-ret-arc185-e/">ARC185E - Adjacent GCD</a>
  / <a href="https://yamate11.github.io/blog/posts/2025/04-27-ret-cf-1021-1-b/">Codeforces R.1021 (Div.1) B. Baggage Claim</a>
</p>


</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://yamate11.github.io/blog/">yamate11のブログ</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
